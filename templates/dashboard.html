<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <title>Dashboard - Data Analytical and Compilation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Custom Title Bar */
        .title-bar {
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .title-bar.draggable { -webkit-app-region: drag; }

        /* Make content selectable */
        .main-content { -webkit-app-region: no-drag; user-select: text; }

        .title-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .title-bar-left span {
            font-size: 1.1em;
            font-weight: 500;
        }

        .project-badge {
            background: #3498db;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .window-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .window-btn {
            width: 36px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 14px;
        }

        .btn-minimize {
            background: #3498db;
            color: white;
        }

        .btn-minimize:hover {
            background: #2980b9;
        }

        .btn-maximize {
            background: #27ae60;
            color: white;
        }

        .btn-maximize:hover {
            background: #219a52;
        }

        .btn-close {
            background: #e74c3c;
            color: white;
        }

        .btn-close:hover {
            background: #c0392b;
        }

        .main-content {
            padding: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .page-header h1 {
            color: #2c3e50;
            font-size: 1.8em;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .back-link {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.2s;
        }

        .back-link:hover {
            background: #2980b9;
        }

        .settings-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-btn:hover {
            background: #8e44ad;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #7f8c8d;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 1px solid #dce1e5;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
            min-width: 200px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.85em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            color: #2c3e50;
            font-size: 2em;
            font-weight: 600;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .data-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .data-item:nth-child(1) { border-left-color: #e74c3c; }
        .data-item:nth-child(2) { border-left-color: #f39c12; }
        .data-item:nth-child(3) { border-left-color: #27ae60; }
        .data-item:nth-child(4) { border-left-color: #9b59b6; }
        .data-item:nth-child(5) { border-left-color: #3498db; }

        .data-name {
            font-weight: 500;
            color: #2c3e50;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 15px;
        }

        .data-count {
            color: #7f8c8d;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Visual Bar Chart */
        .bar-chart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .bar-label {
            min-width: 150px;
            max-width: 150px;
            font-size: 0.85em;
            color: #2c3e50;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .bar-container {
            flex: 1;
            background: #ecf0f1;
            border-radius: 4px;
            height: 24px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.75em;
            color: white;
            font-weight: 600;
        }
        .bar-fill-1 { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .bar-fill-2 { background: linear-gradient(90deg, #f39c12, #d68910); }
        .bar-fill-3 { background: linear-gradient(90deg, #27ae60, #1e8449); }
        .bar-fill-4 { background: linear-gradient(90deg, #9b59b6, #7d3c98); }
        .bar-fill-5 { background: linear-gradient(90deg, #3498db, #2980b9); }
        .bar-fill-6 { background: linear-gradient(90deg, #1abc9c, #16a085); }
        .bar-fill-7 { background: linear-gradient(90deg, #e67e22, #ca6f1e); }
        .bar-fill-8 { background: linear-gradient(90deg, #2c3e50, #1a252f); }
        .bar-fill-9 { background: linear-gradient(90deg, #95a5a6, #7f8c8d); }
        .bar-fill-10 { background: linear-gradient(90deg, #34495e, #2c3e50); }

        /* Chart Type Toggle */
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .chart-type-btn {
            background: #ecf0f1;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            color: #7f8c8d;
        }
        .chart-type-btn.active {
            background: #3498db;
            color: white;
        }
        .chart-type-btn:hover:not(.active) {
            background: #dce1e5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            display: none;
        }

        .spinner {
            border: 3px solid #ecf0f1;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d5f5e3;
            color: #1e8449;
            border: 1px solid #a9dfbf;
        }

        .message.error {
            background: #fadbd8;
            color: #922b21;
            border: 1px solid #f5b7b1;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: #95a5a6;
            font-style: italic;
        }

        .branding {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .branding strong {
            color: #2c3e50;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #2c3e50;
            color: white;
            padding: 20px 25px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #e74c3c;
        }

        .modal-body {
            padding: 25px;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .settings-section p {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .column-select-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .column-select-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .column-select-item label {
            min-width: 120px;
            color: #2c3e50;
            font-weight: 500;
        }

        .column-select-item select {
            flex: 1;
            padding: 10px;
            border: 1px solid #dce1e5;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .column-select-item .display-name {
            width: 150px;
            padding: 10px;
            border: 1px solid #dce1e5;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .add-column-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .add-column-btn:hover {
            background: #219a52;
        }

        .remove-column-btn {
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .remove-column-btn:hover {
            background: #c0392b;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Dark Mode Toggle */
        .theme-toggle { background: #34495e; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; margin-right: 10px; }
        .theme-toggle:hover { background: #4a6278; }

        /* Dark Mode Styles */
        body.dark-mode { background: #1a1a2e; }
        body.dark-mode .main-content { background: #1a1a2e; }
        body.dark-mode .page-header h1 { color: #e0e0e0; }
        body.dark-mode .card { background: #16213e; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        body.dark-mode .card h2 { color: #e0e0e0; border-color: #0f3460; }
        body.dark-mode .stat-card { background: #16213e; }
        body.dark-mode .stat-card h3 { color: #7f8c8d; }
        body.dark-mode .stat-card .value { color: #e0e0e0; }
        body.dark-mode .form-group label { color: #95a5a6; }
        body.dark-mode .form-group input,
        body.dark-mode .form-group select { background: #1a1a2e; border-color: #0f3460; color: #e0e0e0; }
        body.dark-mode .data-item { background: #1a1a2e; }
        body.dark-mode .data-name { color: #e0e0e0; }
        body.dark-mode .data-count { color: #95a5a6; }
        body.dark-mode .no-data { color: #7f8c8d; }
        body.dark-mode .branding { background: #16213e; color: #7f8c8d; }
        body.dark-mode .branding strong { color: #e0e0e0; }
        body.dark-mode .modal { background: #16213e; }
        body.dark-mode .modal-body { color: #e0e0e0; }
        body.dark-mode .settings-section h3 { color: #e0e0e0; }
        body.dark-mode .settings-section p { color: #95a5a6; }
        body.dark-mode .column-select-item label { color: #e0e0e0; }
        body.dark-mode .column-select-item select,
        body.dark-mode .column-select-item .display-name { background: #1a1a2e; border-color: #0f3460; color: #e0e0e0; }
        body.dark-mode .bar-label { color: #e0e0e0; }
        body.dark-mode .bar-container { background: #0f3460; }
        body.dark-mode .chart-type-btn { background: #0f3460; color: #95a5a6; }
        body.dark-mode .chart-type-btn.active { background: #3498db; color: white; }

        /* Comparison View */
        .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .comparison-period { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        body.dark-mode .comparison-period { background: #1a1a2e; }
        .comparison-header { font-weight: 600; color: #2c3e50; margin-bottom: 10px; }
        body.dark-mode .comparison-header { color: #e0e0e0; }
        .comparison-value { font-size: 1.5em; font-weight: 600; }
        .comparison-change { font-size: 0.9em; margin-top: 5px; }
        .comparison-change.positive { color: #27ae60; }
        .comparison-change.negative { color: #e74c3c; }

        /* Comparison Table */
        .comparison-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .comparison-table th { background: #34495e; color: white; padding: 10px; text-align: left; }
        .comparison-table th:nth-child(n+3) { text-align: right; }
        .comparison-table td { padding: 10px; border-bottom: 1px solid #e9ecef; }
        .comparison-table td:nth-child(n+3) { text-align: right; }
        .comparison-table tr:hover { background: #f8f9fa; }
        body.dark-mode .comparison-table td { border-color: #0f3460; }
        body.dark-mode .comparison-table tr:hover { background: #1a1a2e; }
        .change-positive { color: #27ae60; font-weight: 500; }
        .change-negative { color: #e74c3c; font-weight: 500; }
        .change-neutral { color: #7f8c8d; }

        /* Trend Controls */
        .trend-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        .trend-controls select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85em; background: #fff; color: #2c3e50; cursor: pointer; max-width: 220px; }
        .trend-controls select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 2px rgba(52,152,219,0.2); }
        body.dark-mode .trend-controls select { background: #1a1a2e; color: #e0e0e0; border-color: #0f3460; }
        .trend-controls label { font-size: 0.85em; color: #555; font-weight: 500; }
        body.dark-mode .trend-controls label { color: #aaa; }

        /* Tag badges for COUNT/SUM chart headers */
        .tag { display: inline-block; font-size: 0.7em; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 6px; }
        .tag-cnt { background: #eaf4fb; color: #2980b9; }
        .tag-sum { background: #fef9e7; color: #d4880a; }
        body.dark-mode .tag-cnt { background: #1a3a5c; color: #5dade2; }
        body.dark-mode .tag-sum { background: #3d3518; color: #f5b041; }

        /* Chip Input */
        .chip-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 6px; background: #fff; min-height: 34px; cursor: text; position: relative; }
        body.dark-mode .chip-input-wrapper { background: #1a1a2e; border-color: #0f3460; }
        .chip { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #e8f4fd; border-radius: 12px; font-size: 0.8em; color: #2c3e50; white-space: nowrap; }
        body.dark-mode .chip { background: #16213e; color: #aed6f1; }
        .chip-remove { cursor: pointer; font-size: 1.1em; line-height: 1; color: #95a5a6; font-weight: bold; }
        .chip-remove:hover { color: #e74c3c; }
        .chip-search { border: none; outline: none; font-size: 0.85em; flex: 1; min-width: 120px; background: transparent; color: #2c3e50; }
        body.dark-mode .chip-search { color: #e0e0e0; }
        .chip-search::placeholder { color: #aaa; }
        body.dark-mode .chip-search::placeholder { color: #666; }
        .chip-dropdown { position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ddd; border-radius: 0 0 6px 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 20; display: none; }
        body.dark-mode .chip-dropdown { background: #16213e; border-color: #0f3460; }
        .chip-option { padding: 8px 12px; font-size: 0.85em; cursor: pointer; color: #2c3e50; }
        .chip-option:hover { background: #ecf0f1; }
        body.dark-mode .chip-option { color: #e0e0e0; }
        body.dark-mode .chip-option:hover { background: #1a1a2e; }
        .chip-option.selected { background: #e8f4fd; font-weight: 500; }
        body.dark-mode .chip-option.selected { background: #0f3460; }

        /* Line Chart */
        .line-chart-container { position: relative; height: 280px; border-left: 2px solid #ecf0f1; border-bottom: 2px solid #ecf0f1; margin: 15px 0 5px 45px; overflow: hidden; }
        body.dark-mode .line-chart-container { border-color: #0f3460; }
        .line-chart-y-labels { position: absolute; left: 0; top: 0; bottom: 0; width: 45px; display: flex; flex-direction: column-reverse; justify-content: space-between; padding: 0; }
        .line-chart-y-label { font-size: 0.7em; color: #7f8c8d; text-align: right; padding-right: 6px; transform: translateY(50%); }
        body.dark-mode .line-chart-y-label { color: #95a5a6; }
        .line-chart-grid-line { position: absolute; left: 0; right: 0; height: 1px; background: #ecf0f1; pointer-events: none; }
        body.dark-mode .line-chart-grid-line { background: #0f3460; }
        .line-chart-x-labels { display: flex; justify-content: space-between; margin-left: 45px; padding-top: 6px; }
        .line-chart-x-label { font-size: 0.72em; color: #7f8c8d; text-align: center; flex: 1; }
        body.dark-mode .line-chart-x-label { color: #95a5a6; }
        .line-segment { position: absolute; transform-origin: left center; height: 2px; z-index: 1; border-radius: 1px; transition: opacity .2s; }
        .line-dot { position: absolute; width: 8px; height: 8px; border-radius: 50%; transform: translate(-50%, 50%); z-index: 10; cursor: default; border: 2px solid #fff; box-sizing: border-box; transition: width 0.2s, height 0.2s, opacity 0.2s; }
        body.dark-mode .line-dot { border-color: #16213e; }
        .line-dot:hover::after { content: attr(data-tooltip); position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.88); color: #fff; padding: 4px 9px; border-radius: 4px; font-size: 0.72em; white-space: nowrap; z-index: 20; pointer-events: none; }
        .line-dot.ecg-hovered { width: 14px; height: 14px; }

        /* Line Chart Legend â€” clickable with isolation state */
        .line-chart-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; padding: 6px 0; justify-content: center; }
        .legend-item {
            display: flex; align-items: center; gap: 5px; font-size: 0.8em; color: #555;
            cursor: pointer; padding: 3px 8px; border-radius: 20px;
            border: 1.5px solid transparent;
            transition: opacity .2s, border-color .2s, background .2s;
            user-select: none;
        }
        .legend-item:hover { background: rgba(0,0,0,.04); }
        .legend-item.lg-isolated { border-color: currentColor; background: rgba(255,255,255,.9); font-weight: 700; }
        .legend-item.lg-dimmed { opacity: 0.28; }
        body.dark-mode .legend-item { color: #bbb; }
        body.dark-mode .legend-item:hover { background: rgba(255,255,255,.06); }
        body.dark-mode .legend-item.lg-isolated { background: rgba(255,255,255,.08); }
        .legend-line { width: 18px; height: 3px; border-radius: 2px; flex-shrink: 0; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .legend-hint { font-size: .72em; color: #aaa; text-align: center; padding: 2px 0 4px; font-style: italic; }
        body.dark-mode .legend-hint { color: #666; }
        .chart-summary { margin-top: 4px; text-align: center; color: #7f8c8d; font-size: .85em; }
        body.dark-mode .chart-summary { color: #95a5a6; }

        /* ECG / Medical Monitor Theme (scoped to chart wrapper divs via .ecg-theme-wrap) */
        .ecg-theme-wrap { background: #0a0a0a; border: 1px solid #00802060; border-radius: 8px; padding: 12px 8px 8px; box-shadow: 0 0 20px rgba(0,255,65,0.08); }
        .ecg-theme-wrap .line-chart-container { border-color: #00802040; }
        .ecg-theme-wrap .line-chart-grid-line { background: rgba(0,80,0,0.5); }
        .ecg-theme-wrap .line-chart-y-label { color: #00ff41; font-family: 'Courier New', monospace; }
        .ecg-theme-wrap .line-chart-x-label { color: #00ff41; font-family: 'Courier New', monospace; }
        .ecg-theme-wrap .line-dot { border-color: #0a0a0a; }
        .ecg-theme-wrap .legend-item { color: #00ff41; font-family: 'Courier New', monospace; }
        .ecg-theme-wrap .legend-item:hover { background: rgba(0,255,65,.06); }
        .ecg-theme-wrap .legend-item.lg-isolated { background: rgba(0,255,65,.1); }
        .ecg-theme-wrap .chart-summary { color: #00802090; font-family: 'Courier New', monospace; }
        .ecg-theme-wrap .legend-hint { color: #00802080; }
        .ecg-theme-wrap .ecg-x-label { color: #00ff41; font-family: 'Courier New', monospace; }
        .ecg-theme-wrap .ecg-month-sep { border-left-color: rgba(0,128,0,0.35); }
        .ecg-theme-wrap .no-data { color: #00804080; }
        .ecg-baseline-line { position: absolute; left: 0; right: 0; height: 1px; border-top: 2px dashed #ffffff80; z-index: 3; pointer-events: none; }
        .ecg-baseline-label { position: absolute; right: 4px; top: -14px; font-size: 0.65em; color: #ffffff80; font-family: 'Courier New', monospace; pointer-events: none; }
        .baseline-highlight { font-weight: 700; text-decoration: underline; text-underline-offset: 3px; }

        /* ECG Sequential Pulse Design */
        .ecg-month-sep { position: absolute; top: 0; bottom: 0; width: 1px; border-left: 1px dashed rgba(0,128,0,0.25); z-index: 1; pointer-events: none; }
        /* ECG dot labels â€” pill, two-line, collision-free, hover pop-out */
        .ecg-dot-label {
            position: absolute; font-family: 'Courier New', monospace;
            z-index: 20; pointer-events: auto; line-height: 1.35;
            background: rgba(0,14,18,0.94); padding: 2px 6px;
            border-radius: 8px; border: 1px solid;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.96);
            text-align: center; white-space: nowrap; cursor: default;
            transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, opacity 0.18s ease;
        }
        .ecg-dot-label .lbl-mov  { font-size: 0.68em; font-weight: bold; display: block; }
        .ecg-dot-label .lbl-grp  { font-size: 0.55em; opacity: 0.75; display: block; }
        .ecg-dot-label .lbl-full { font-size: 0.52em; opacity: 0; max-height: 0; overflow: hidden; display: block; transition: opacity 0.18s, max-height 0.18s; }
        /* Light variant for non-ECG RAW mode */
        .ecg-dot-label[data-ecg="false"] {
            background: rgba(255,255,255,.97);
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,.18), 0 0 0 1px rgba(0,0,0,.06);
        }
        .ecg-dot-label.ecg-dimmed  { opacity: 0.18; transform: translateX(-50%) scale(0.92) !important; }
        .ecg-dot-label.ecg-hovered { transform: translateX(-50%) scale(1.3) !important; z-index: 30; padding: 4px 10px; border-width: 1.5px; background: rgba(0,14,18,0.98); }
        .ecg-dot-label[data-ecg="false"].ecg-hovered { background: rgba(255,255,255,1); }
        .ecg-dot-label.ecg-hovered .lbl-grp  { opacity: 1; }
        .ecg-dot-label.ecg-hovered .lbl-full { opacity: 0.85; max-height: 30px; }
        /* ECG leader lines */
        .ecg-leader { position: absolute; z-index: 6; pointer-events: none; transition: opacity 0.18s; }
        .ecg-leader.ecg-dimmed  { opacity: 0.06; }
        .ecg-leader.ecg-hovered { opacity: 0.9; }
        .ecg-x-label { position: absolute; transform: translateX(-50%); font-size: 0.72em; color: #7f8c8d; text-align: center; white-space: nowrap; top: 6px; }
        body.dark-mode .ecg-x-label { color: #95a5a6; }
        .line-chart-x-labels.ecg-mode { display: block !important; position: relative; height: 40px; }

        .ecg-toggle-btn { background: #444; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8em; transition: background 0.2s, box-shadow 0.2s; }
        .ecg-toggle-btn:hover { background: #555; }
        .ecg-toggle-btn.active { background: #00802080; color: #00ff41; box-shadow: 0 0 8px rgba(0,255,65,0.3); }

        /* Mode toggle (RAW/MOVEMENT) - reuses agg-toggle pattern */
        .mode-toggle { display: inline-flex; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .mode-toggle button { padding: 6px 14px; border: none; background: #fff; color: #555; font-size: 0.85em; cursor: pointer; font-weight: 500; transition: background 0.2s, color 0.2s; }
        .mode-toggle button.active { background: #9b59b6; color: #fff; }
        .mode-toggle button:hover:not(.active) { background: #ecf0f1; }
        body.dark-mode .mode-toggle { border-color: #0f3460; }
        body.dark-mode .mode-toggle button { background: #1a1a2e; color: #aaa; }
        body.dark-mode .mode-toggle button.active { background: #9b59b6; color: #fff; }
        body.dark-mode .mode-toggle button:hover:not(.active) { background: #16213e; }

        /* Trend date inputs in controls row */
        .trend-controls input[type="date"] { padding: 5px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85em; background: #fff; color: #2c3e50; cursor: pointer; max-width: 150px; }
        body.dark-mode .trend-controls input[type="date"] { background: #1a1a2e; color: #e0e0e0; border-color: #0f3460; }

        /* Date Picker Styling for better visibility */
        input[type="date"] {
            cursor: pointer;
            background-color: #fff;
            font-weight: 500;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            background-color: #3498db;
            filter: invert(1);
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            background-color: #2980b9;
        }
        input[type="date"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }
        body.dark-mode input[type="date"] {
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: #3498db;
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .page-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-buttons {
                flex-direction: column;
                width: 100%;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .column-select-item {
                flex-direction: column;
                align-items: stretch;
            }

            .column-select-item label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Custom Title Bar -->
    <div class="title-bar draggable" id="titleBar">
        <div class="title-bar-left">
            <span>Data Analytical and Compilation Tool - Dashboard</span>
            <span class="project-badge" id="projectBadge">Loading...</span>
        </div>
        <div class="window-controls">
            <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode" id="themeToggle">ðŸŒ™</button>
            <button class="window-btn btn-minimize" onclick="minimizeWindow()" title="Minimize">&#8211;</button>
            <button class="window-btn btn-maximize" onclick="maximizeWindow()" title="Maximize" id="maximizeBtn">&#9633;</button>
            <button class="window-btn btn-close" onclick="closeWindow()" title="Close">&#10005;</button>
        </div>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h1>Dashboard</h1>
            <div class="header-buttons">
                <button class="btn" style="background:#e67e22;" onclick="showComparison()">Compare Periods</button>
                <button class="btn" style="background:#16a085;" onclick="showAdvancedAnalysis()">Advanced Analysis</button>
                <button class="settings-btn" onclick="openSettings()">Top 10 Analysis</button>
                <a href="/" class="back-link">Back to Upload</a>
            </div>
        </div>

        <div class="message" id="message"></div>

        <div class="card">
            <div class="filters">
                <div class="form-group">
                    <label for="dateColumnSelect">Date Column</label>
                    <select id="dateColumnSelect" onchange="saveDateColumn()">
                        <option value="">-- Select Date Column --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn" onclick="loadDashboard()">Apply Filter</button>
                <button class="btn btn-success" onclick="downloadFiltered()">Download Filtered Data</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading dashboard data...</p>
        </div>

        <div id="dashboardContent">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Records</h3>
                    <div class="value" id="totalRecords">-</div>
                </div>
                <div class="stat-card">
                    <h3>Date Range</h3>
                    <div class="value" id="dateRange" style="font-size: 1em;">-</div>
                </div>
            </div>

            <!-- Dual Trend Charts Section -->
            <div id="trendSection" style="display:none;">

                <!-- SHARED CONTROLS CARD -->
                <div class="card" id="trendControlsCard">
                    <div class="trend-controls">
                        <label>Group by:</label>
                        <select id="trendGroupSelect" onchange="onTrendControlChange()">
                            <option value="">-- Select Column --</option>
                        </select>
                        <label>Show:</label>
                        <select id="trendShowSelect" onchange="onShowChange()">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                            <option value="25">Top 25</option>
                            <option value="0">Specific...</option>
                        </select>
                        <label>Trend Start:</label>
                        <input type="date" id="trendStartDate" onchange="onTrendDateChange()">
                        <label>Trend End:</label>
                        <input type="date" id="trendEndDate" onchange="onTrendDateChange()">
                    </div>
                    <div id="chipRow" class="trend-controls" style="display:none;">
                        <label>Groups:</label>
                        <div class="chip-input-wrapper" onclick="focusChipSearch()">
                            <span id="chipContainer"></span>
                            <input type="text" class="chip-search" id="chipSearchInput" placeholder="Search groups..." oninput="onChipSearchInput()" onfocus="showChipDropdown()">
                            <div class="chip-dropdown" id="chipDropdown"></div>
                        </div>
                    </div>
                </div>

                <!-- COUNT CARD -->
                <div class="card" id="trendCountCard">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h2 style="margin:0;">Monthly Trend <span class="tag tag-cnt">COUNT</span></h2>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <button class="ecg-toggle-btn" id="ecgBtnCount" onclick="toggleEcg('Count')" title="ECG Monitor Theme">&#9829; ECG</button>
                            <button class="btn btn-sm" style="background:#27ae60; padding:6px 12px; font-size:0.8em;" onclick="downloadTrendLineExcel('Count')" title="Download as Excel">&#11015; Excel</button>
                        </div>
                    </div>
                    <div id="wrapCount">
                        <div style="position:relative;">
                            <div class="line-chart-y-labels" id="ylCount"></div>
                            <div class="line-chart-container" id="areaCount">
                                <div class="no-data">Select a group-by column to see trend</div>
                            </div>
                        </div>
                        <div class="line-chart-x-labels" id="xlCount"></div>
                        <div class="line-chart-legend" id="legCount"></div>
                        <div class="legend-hint" id="hintCount">Click groups to select/deselect &middot; ESC to clear all</div>
                        <div class="chart-summary" id="sumCount"></div>
                    </div>
                </div>

                <!-- SUM CARD -->
                <div class="card" id="trendSumCard">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h2 style="margin:0;">Monthly Trend <span class="tag tag-sum">SUM</span></h2>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <button class="ecg-toggle-btn" id="ecgBtnSum" onclick="toggleEcg('Sum')" title="ECG Monitor Theme">&#9829; ECG</button>
                            <button class="btn btn-sm" style="background:#27ae60; padding:6px 12px; font-size:0.8em;" onclick="downloadTrendLineExcel('Sum')" title="Download as Excel">&#11015; Excel</button>
                        </div>
                    </div>
                    <div class="trend-controls">
                        <label>Value:</label>
                        <select id="trendValueSelect" onchange="onTrendControlChange()" style="min-width:180px;">
                            <option value="">(Row Count)</option>
                        </select>
                    </div>
                    <div class="trend-controls">
                        <div class="mode-toggle">
                            <button id="modeRaw" class="active" onclick="setSumChartMode('raw')">RAW</button>
                            <button id="modeMovement" onclick="setSumChartMode('movement')">MOVEMENT</button>
                        </div>
                        <label id="baselineLabel" style="display:none;">Baseline:</label>
                        <select id="baselineMonthSelect" style="display:none;" onchange="onTrendControlChange()">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div id="wrapSum">
                        <div style="position:relative;">
                            <div class="line-chart-y-labels" id="ylSum"></div>
                            <div class="line-chart-container" id="areaSum">
                                <div class="no-data">Select a group-by column to see trend</div>
                            </div>
                        </div>
                        <div class="line-chart-x-labels" id="xlSum"></div>
                        <div class="line-chart-legend" id="legSum"></div>
                        <div class="legend-hint" id="hintSum">Click groups to select/deselect &middot; ESC to clear all</div>
                        <div class="chart-summary" id="sumSum"></div>
                    </div>
                </div>

            </div>

            <!-- Column Analysis -->
            <div class="card" id="columnStatsCard" style="display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h2 style="margin:0;">Column Analysis</h2>
                    <button class="btn btn-sm" style="background:#27ae60; padding:6px 12px; font-size:0.8em;" onclick="downloadColumnStats()" title="Download as Excel">â¬‡ Excel</button>
                </div>
                <div style="max-height: 400px; overflow-y: auto;" id="columnStatsContent">
                    <div class="no-data">Loading column analysis...</div>
                </div>
            </div>

            <div style="margin-bottom: 15px; text-align: right;">
                <button class="btn" style="background:#9b59b6;" onclick="exportPDF()">Export PDF</button>
            </div>

            <div class="chart-grid" id="chartGrid">
                <div class="no-data">Configure columns in settings and click "Apply Filter"</div>
            </div>

            <!-- Comparison Section (populated by Compare Periods) -->
            <div class="card" id="comparisonSection" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0;" id="comparisonTitle">Period Comparison</h2>
                    <button class="btn btn-sm" style="background:#27ae60; padding:6px 12px; font-size:0.8em;" onclick="downloadComparison()" title="Download full comparison as Excel">
                        â¬‡ Excel
                    </button>
                </div>
                <div id="comparisonTableContainer"></div>
            </div>

            <!-- Advanced Analysis Section (populated by Advanced Analysis) -->
            <div class="card" id="advancedAnalysisSection" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0;" id="advancedAnalysisTitle">Advanced Comparative Analysis</h2>
                    <button class="btn btn-sm" style="background:#27ae60; padding:6px 12px; font-size:0.8em;" onclick="downloadAdvancedAnalysis()" title="Download advanced analysis as Excel">
                        â¬‡ Excel
                    </button>
                </div>
                <div id="advancedAnalysisTableContainer"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Dashboard Column Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Top 10 Columns</h3>
                    <p>Select columns to display as Top 10 charts (max 6)</p>
                    <div class="column-select-group" id="columnSelectGroup">
                        <!-- Dynamic column selectors will be added here -->
                    </div>
                    <button class="add-column-btn" onclick="addColumnSelector()" id="addColumnBtn">+ Add Column</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        let minDate = null;
        let maxDate = null;
        let availableColumns = [];
        let currentSettings = {
            date_column: '',
            top_columns: []
        };
        let currentProject = '';

        // Date formatting function - DD-MMM-YYYY
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Format month for trend (MMM-YYYY)
        function formatMonth(monthStr) {
            if (!monthStr) return '-';
            // monthStr is in format "YYYY-MM"
            const [year, month] = monthStr.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[parseInt(month) - 1]}-${year}`;
        }

        // Window control functions
        let isMaximized = false;

        async function minimizeWindow() {
            if (window.pywebview?.api) {
                try {
                    await window.pywebview.api.minimize_window();
                } catch (e) {
                    console.error('Minimize error:', e);
                }
            }
        }

        async function maximizeWindow() {
            if (window.pywebview?.api) {
                try {
                    const result = await window.pywebview.api.maximize_window();
                    if (result && result.success) {
                        isMaximized = result.maximized;
                        updateTitleBarDrag();
                    }
                } catch (e) {
                    console.error('Maximize error:', e);
                }
            }
        }

        async function closeWindow() {
            if (window.pywebview?.api) {
                try {
                    await window.pywebview.api.close_window();
                } catch (e) {
                    console.error('Close error:', e);
                    window.close();
                }
            } else {
                window.close();
            }
        }

        function updateTitleBarDrag() {
            const titleBar = document.getElementById('titleBar');
            if (isMaximized) {
                titleBar.classList.remove('draggable');
            } else {
                titleBar.classList.add('draggable');
            }
        }

        // Load everything on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Double-click on title bar to maximize/restore
            const titleBar = document.getElementById('titleBar');
            titleBar.addEventListener('dblclick', (e) => {
                if (e.target.closest('.window-controls')) return;
                maximizeWindow();
            });
            // Toggle date picker on click (click to open, click again to close)
            document.querySelectorAll('input[type="date"]').forEach(input => {
                let pickerOpen = false;
                input.addEventListener('click', (e) => {
                    if (pickerOpen) {
                        e.preventDefault();
                        input.blur();
                        pickerOpen = false;
                    } else {
                        pickerOpen = true;
                    }
                });
                input.addEventListener('blur', () => { pickerOpen = false; });
                input.addEventListener('change', () => { pickerOpen = false; });
            });

            await Promise.all([loadProjectInfo(), loadColumns(), loadSettings(), loadDateRange()]);

            // â”€â”€ Restore saved UI state for this project â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            try { _savedState = JSON.parse(localStorage.getItem('dash_state_' + currentProject) || 'null'); }
            catch(e) { _savedState = null; }

            if (_savedState) {
                // Date range â€” clamp to actual data bounds
                const sd = document.getElementById('startDate');
                const ed = document.getElementById('endDate');
                if (_savedState.startDate && minDate && _savedState.startDate >= minDate && _savedState.startDate <= (maxDate || '9'))
                    sd.value = _savedState.startDate;
                if (_savedState.endDate && maxDate && _savedState.endDate <= maxDate && _savedState.endDate >= (minDate || ''))
                    ed.value = _savedState.endDate;

                // Trend group column
                const tgs = document.getElementById('trendGroupSelect');
                if (_savedState.trendGroup && [...tgs.options].some(o => o.value === _savedState.trendGroup))
                    tgs.value = _savedState.trendGroup;

                // Trend value column (now always visible in SUM card)
                const tvs = document.getElementById('trendValueSelect');
                if (_savedState.trendValue !== undefined && [...tvs.options].some(o => o.value === _savedState.trendValue))
                    tvs.value = _savedState.trendValue;

                // Top N / specific groups
                const tss = document.getElementById('trendShowSelect');
                if (_savedState.trendShow) tss.value = _savedState.trendShow;
                if (_savedState.trendShow === '0') {
                    document.getElementById('chipRow').style.display = 'flex';
                    if (_savedState.specificGroups) { selectedSpecificGroups = _savedState.specificGroups; renderChips(); }
                }

                // SUM chart mode (RAW vs MOVEMENT)
                if (_savedState.sumChartMode === 'movement') {
                    sumChartMode = 'movement';
                    document.getElementById('modeRaw').classList.remove('active');
                    document.getElementById('modeMovement').classList.add('active');
                    document.getElementById('baselineLabel').style.display = '';
                    document.getElementById('baselineMonthSelect').style.display = '';
                }

                // Per-chart ECG theme
                if (_savedState.countEcg) {
                    countEcg = true;
                    document.getElementById('wrapCount').classList.add('ecg-theme-wrap');
                    document.getElementById('ecgBtnCount').classList.add('active');
                }
                if (_savedState.sumEcg) {
                    sumEcg = true;
                    document.getElementById('wrapSum').classList.add('ecg-theme-wrap');
                    document.getElementById('ecgBtnSum').classList.add('active');
                }
            }

            renderChartContainers();
            loadDashboard();
        });

        async function loadProjectInfo() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                if (data.success && data.current_project) {
                    currentProject = data.current_project;
                    document.getElementById('projectBadge').textContent = currentProject;
                } else {
                    document.getElementById('projectBadge').textContent = 'No Project';
                }
            } catch (error) {
                console.error('Error loading project info:', error);
            }
        }

        let dateColumns = [];
        let numericColumns = [];
        let lastAdvancedParams = null;

        async function loadColumns() {
            try {
                const response = await fetch('/api/columns');
                const data = await response.json();
                if (data.success) {
                    availableColumns = data.columns;
                    dateColumns = data.date_columns || data.columns;
                    numericColumns = data.numeric_columns || [];
                    populateColumnSelectors();
                }
            } catch (error) {
                console.error('Error loading columns:', error);
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                if (data.success) {
                    currentSettings = data.settings;
                    document.getElementById('dateColumnSelect').value = currentSettings.date_column || '';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function populateColumnSelectors() {
            const dateSelect = document.getElementById('dateColumnSelect');
            dateSelect.innerHTML = '<option value="">-- Select Date Column --</option>';

            dateColumns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                dateSelect.appendChild(option);
            });

            // Set current date column
            if (currentSettings.date_column) {
                dateSelect.value = currentSettings.date_column;
            }

            // Populate top column selectors
            const group = document.getElementById('columnSelectGroup');
            group.innerHTML = '';

            if (currentSettings.top_columns && currentSettings.top_columns.length > 0) {
                currentSettings.top_columns.forEach((col, index) => {
                    addColumnSelector(col.column, col.display_name);
                });
            } else {
                // Add one empty selector by default
                addColumnSelector();
            }

            // Populate trend line group-by dropdown
            const trendGroupSelect = document.getElementById('trendGroupSelect');
            if (trendGroupSelect) {
                trendGroupSelect.innerHTML = '<option value="">-- Select Column --</option>';
                let firstCol = null;
                availableColumns.forEach(col => {
                    if (col !== '_upload_id') {
                        const opt = document.createElement('option');
                        opt.value = col;
                        opt.textContent = col;
                        trendGroupSelect.appendChild(opt);
                        if (!firstCol) firstCol = col;
                    }
                });
                // Auto-select first column so chart shows immediately
                if (firstCol) trendGroupSelect.value = firstCol;
            }

            // Populate trend line value dropdown (numeric columns only)
            const trendValueSelect = document.getElementById('trendValueSelect');
            if (trendValueSelect) {
                trendValueSelect.innerHTML = '<option value="">(Row Count)</option>';
                (numericColumns || []).forEach(col => {
                    const opt = document.createElement('option');
                    opt.value = col;
                    opt.textContent = col;
                    trendValueSelect.appendChild(opt);
                });
            }
        }

        function addColumnSelector(selectedColumn = '', displayName = '') {
            const group = document.getElementById('columnSelectGroup');
            const existingSelectors = group.querySelectorAll('.column-select-item').length;

            if (existingSelectors >= 6) {
                showMessage('Maximum 6 columns allowed', 'error');
                return;
            }

            const div = document.createElement('div');
            div.className = 'column-select-item';
            div.innerHTML = `
                <label>Column ${existingSelectors + 1}:</label>
                <select class="column-select">
                    <option value="">-- Select Column --</option>
                    ${availableColumns.map(col =>
                        `<option value="${col}" ${col === selectedColumn ? 'selected' : ''}>${col}</option>`
                    ).join('')}
                </select>
                <input type="text" class="display-name" placeholder="Display Name" value="${displayName}">
                <button class="remove-column-btn" onclick="removeColumnSelector(this)">&times;</button>
            `;
            group.appendChild(div);

            updateAddButtonVisibility();
        }

        function removeColumnSelector(btn) {
            const group = document.getElementById('columnSelectGroup');
            const items = group.querySelectorAll('.column-select-item');

            if (items.length <= 1) {
                showMessage('At least one column is required', 'error');
                return;
            }

            btn.closest('.column-select-item').remove();

            // Renumber labels
            const newItems = group.querySelectorAll('.column-select-item');
            newItems.forEach((item, index) => {
                item.querySelector('label').textContent = `Column ${index + 1}:`;
            });

            updateAddButtonVisibility();
        }

        function updateAddButtonVisibility() {
            const group = document.getElementById('columnSelectGroup');
            const existingSelectors = group.querySelectorAll('.column-select-item').length;
            document.getElementById('addColumnBtn').style.display = existingSelectors >= 6 ? 'none' : 'block';
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function saveSettings() {
            const columnItems = document.querySelectorAll('.column-select-item');

            const topColumns = [];
            columnItems.forEach(item => {
                const select = item.querySelector('.column-select');
                const displayNameInput = item.querySelector('.display-name');
                if (select.value) {
                    topColumns.push({
                        column: select.value,
                        display_name: displayNameInput.value || select.value
                    });
                }
            });

            if (topColumns.length === 0) {
                showMessage('Please select at least one column for Top 10', 'error');
                return;
            }

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date_column: currentSettings.date_column,
                        top_columns: topColumns
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentSettings.top_columns = topColumns;
                    closeSettings();
                    showMessage('Settings saved successfully!', 'success');
                    renderChartContainers();
                    loadDashboard();
                } else {
                    showMessage(data.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                showMessage('Error saving settings: ' + error.message, 'error');
            }
        }

        async function saveDateColumn() {
            const dateColumn = document.getElementById('dateColumnSelect').value;
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date_column: dateColumn,
                        top_columns: currentSettings.top_columns
                    })
                });
                const data = await response.json();
                if (data.success) {
                    currentSettings.date_column = dateColumn;
                    await loadDateRange();
                    showMessage('Date column updated', 'success');
                } else {
                    showMessage(data.error || 'Failed to save date column', 'error');
                }
            } catch (error) {
                showMessage('Error saving date column: ' + error.message, 'error');
            }
        }

        function renderChartContainers() {
            const grid = document.getElementById('chartGrid');
            grid.innerHTML = '';

            if (!currentSettings.top_columns || currentSettings.top_columns.length === 0) {
                grid.innerHTML = '<div class="no-data">Configure columns in settings and click "Apply Filter"</div>';
                return;
            }

            currentSettings.top_columns.forEach((col, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h2 style="margin:0;">Top 10 ${col.display_name}</h2>
                        <button class="btn btn-sm" style="background:#27ae60; padding:6px 12px; font-size:0.8em;" onclick="downloadChartData('${col.column}', '${col.display_name}')" title="Download as Excel">
                            â¬‡ Excel
                        </button>
                    </div>
                    <div id="chart_${index}" class="data-list">
                        <div class="no-data">Select a date range and click "Apply Filter"</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Store chart data for download
        let chartDataStore = {};

        async function downloadChartData(column, displayName) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showMessage('Please select a date range first', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/download-top10?column=${encodeURIComponent(column)}&start_date=${startDate}&end_date=${endDate}&display_name=${encodeURIComponent(displayName)}`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Top10_${displayName.replace(/[^a-zA-Z0-9]/g, '_')}_${startDate}_to_${endDate}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessage(`Downloaded Top 10 ${displayName}`, 'success');
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Download failed', 'error');
                }
            } catch (error) {
                showMessage('Error downloading: ' + error.message, 'error');
            }
        }

        async function loadDateRange() {
            try {
                const response = await fetch('/api/date-range');
                const data = await response.json();

                if (data.success) {
                    minDate = data.min_date;
                    maxDate = data.max_date;

                    document.getElementById('startDate').value = minDate;
                    document.getElementById('endDate').value = maxDate;
                    document.getElementById('startDate').min = minDate;
                    document.getElementById('startDate').max = maxDate;
                    document.getElementById('endDate').min = minDate;
                    document.getElementById('endDate').max = maxDate;
                }
            } catch (error) {
                console.error('Error loading date range:', error);
            }
        }

        async function loadDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('Start date must be before end date', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboardContent').style.opacity = '0.5';
            hideMessage();

            try {
                const response = await fetch(`/api/dashboard-stats?start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();

                if (data.success) {
                    updateDashboard(data);
                    showMessage('Dashboard updated successfully!', 'success');
                } else {
                    showMessage(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboardContent').style.opacity = '1';
                _savedState   = null;   // restore complete â€” stop intercepting future interactions
                _uiStateReady = true;
                saveUiState();          // persist current state as the new baseline
            }
        }

        function updateDashboard(data) {
            // Update stats
            document.getElementById('totalRecords').textContent = data.total_records.toLocaleString();
            document.getElementById('dateRange').textContent = `${formatDate(data.date_range.start)} to ${formatDate(data.date_range.end)}`;

            // Update Top 10 charts
            if (data.top_data) {
                currentSettings.top_columns.forEach((col, index) => {
                    const chartData = data.top_data[col.column] || {};
                    updateChart(`chart_${index}`, chartData, col.display_name);
                });
            }

            // Initialize trend date inputs to main filter range
            const mainStart = document.getElementById('startDate').value;
            const mainEnd = document.getElementById('endDate').value;
            const trendStart = document.getElementById('trendStartDate');
            const trendEnd = document.getElementById('trendEndDate');
            trendStart.value = mainStart;
            trendEnd.value = mainEnd;
            trendStart.min = mainStart;
            trendStart.max = mainEnd;
            trendEnd.min = mainStart;
            trendEnd.max = mainEnd;

            // Restore saved trend dates if within bounds
            if (_savedState) {
                if (_savedState.trendStartDate && _savedState.trendStartDate >= mainStart) trendStart.value = _savedState.trendStartDate;
                if (_savedState.trendEndDate   && _savedState.trendEndDate   <= mainEnd)   trendEnd.value   = _savedState.trendEndDate;
            }

            // Load trend line chart and column analysis in parallel
            Promise.all([onTrendControlChange(), loadColumnStats()]);
        }

        // 10-color palette for line chart groups
        const lineColors = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
            '#1abc9c', '#e67e22', '#34495e', '#d35400', '#8e44ad'
        ];

        function formatNumber(val) {
            if (Number.isInteger(val) || Math.abs(val - Math.round(val)) < 0.001) {
                return Math.round(val).toLocaleString();
            }
            return val.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 2 });
        }

        let selectedSpecificGroups = [];
        let allGroupValues = [];
        // Dual-chart state
        let lastCountData = null;
        let lastSumData   = null;
        let countEcg      = false;
        let sumEcg        = false;
        let sumChartMode  = 'raw'; // 'raw' or 'movement' (COUNT is always 'raw')
        let countIsolated = new Set();
        let sumIsolated   = new Set();
        const ecgColors = ['#00ffff', '#ff00ff', '#00ff41', '#ffff00', '#ff3333', '#ff8800', '#00ccff', '#ff66cc', '#66ff66', '#ffcc00'];
        const rafHandles = { Count: null, Sum: null };

        // â”€â”€ Dashboard state persistence (survives refresh) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let _savedState    = null;   // holds restored state during initial load
        let _uiStateReady  = false;  // true after first loadDashboard() completes

        function saveUiState() {
            if (!currentProject || !_uiStateReady) return;
            try {
                localStorage.setItem('dash_state_' + currentProject, JSON.stringify({
                    startDate:      document.getElementById('startDate').value,
                    endDate:        document.getElementById('endDate').value,
                    trendGroup:     document.getElementById('trendGroupSelect').value,
                    trendValue:     document.getElementById('trendValueSelect').value,
                    trendShow:      document.getElementById('trendShowSelect').value,
                    specificGroups: selectedSpecificGroups,
                    trendStartDate: document.getElementById('trendStartDate').value,
                    trendEndDate:   document.getElementById('trendEndDate').value,
                    countEcg:       countEcg,
                    sumEcg:         sumEcg,
                    sumChartMode:   sumChartMode,
                    sumBaselineMonth: document.getElementById('baselineMonthSelect').value
                }));
            } catch(e) {}
        }

        function setSumChartMode(mode) {
            sumChartMode = mode;
            document.getElementById('modeRaw').classList.toggle('active', mode === 'raw');
            document.getElementById('modeMovement').classList.toggle('active', mode === 'movement');
            const showBaseline = mode === 'movement';
            document.getElementById('baselineLabel').style.display = showBaseline ? '' : 'none';
            document.getElementById('baselineMonthSelect').style.display = showBaseline ? '' : 'none';
            onTrendControlChange();
        }

        function onTrendDateChange() {
            const mainStart = document.getElementById('startDate').value;
            const mainEnd = document.getElementById('endDate').value;
            const trendStart = document.getElementById('trendStartDate');
            const trendEnd = document.getElementById('trendEndDate');
            if (mainStart && trendStart.value && trendStart.value < mainStart) trendStart.value = mainStart;
            if (mainEnd && trendEnd.value && trendEnd.value > mainEnd) trendEnd.value = mainEnd;
            if (trendStart.value && trendEnd.value && trendStart.value > trendEnd.value) trendEnd.value = trendStart.value;
            saveUiState();
            onTrendControlChange();
        }

        function populateBaselineMonths(months) {
            const sel = document.getElementById('baselineMonthSelect');
            const prev = sel.value;
            sel.innerHTML = '<option value="">-- Select --</option>';
            (months || []).forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = formatMonth(m);
                sel.appendChild(opt);
            });
            if (prev && months && months.includes(prev)) sel.value = prev;
            if (_savedState && _savedState.sumBaselineMonth && months && months.includes(_savedState.sumBaselineMonth))
                sel.value = _savedState.sumBaselineMonth;
        }

        function toggleEcg(which) {
            if (which === 'Count') { countEcg = !countEcg; }
            else                   { sumEcg   = !sumEcg;   }
            const isEcg = which === 'Count' ? countEcg : sumEcg;
            document.getElementById('ecgBtn' + which).classList.toggle('active', isEcg);
            const wrap = document.getElementById('wrap' + which);
            wrap.classList.toggle('ecg-theme-wrap', isEcg);
            saveUiState();
            // Re-render that chart
            if (which === 'Count' && lastCountData) renderCountChart(lastCountData);
            if (which === 'Sum'   && lastSumData)   renderSumChart(lastSumData);
        }

        // â”€â”€ Format helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function fmtY(v) {
            const a = Math.abs(v);
            if (a >= 1e6) return (v / 1e6).toFixed(1) + 'M';
            if (a >= 1e3) return (v / 1e3).toFixed(1) + 'K';
            return Math.round(v).toLocaleString();
        }
        function fmtMov(v) {
            const a = Math.abs(v), s = v >= 0 ? '+' : '-';
            if (a >= 1e6) return s + (a / 1e6).toFixed(1) + 'M';
            if (a >= 1e3) return s + (a / 1e3).toFixed(0) + 'K';
            return s + Math.round(a).toLocaleString();
        }

        function getNiceMax(maxVal, ticks) {
            if (maxVal <= 0) return ticks;
            const rough = maxVal / (ticks - 1);
            const mag = Math.pow(10, Math.floor(Math.log10(rough)));
            const residual = rough / mag;
            let nice;
            if (residual <= 1.5) nice = 1;
            else if (residual <= 3) nice = 2;
            else if (residual <= 7) nice = 5;
            else nice = 10;
            const step = nice * mag;
            return Math.ceil(maxVal / step) * step;
        }

        function getNiceMaxBipolar(maxAbs) {
            if (!maxAbs) return 1;
            const mag = Math.pow(10, Math.floor(Math.log10(maxAbs)));
            const r = maxAbs / mag;
            const n = (r <= 1.5 ? 1 : r <= 3 ? 2 : r <= 7 ? 5 : 10) * mag;
            return Math.ceil(maxAbs / n) * n;
        }

        // â”€â”€ ECG label placement helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function ecgHexToRgb(hex) {
            return [parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)].join(',');
        }
        function ecgPreferredTop(dotY_px, mov, labelH, gap, chartH) {
            const above = dotY_px - gap - labelH;
            const below = dotY_px + gap;
            if (mov >= 0) {
                if (above >= 0)               return above;
                if (below + labelH <= chartH) return below;
                return Math.max(0, above);
            } else {
                if (below + labelH <= chartH) return below;
                if (above >= 0)               return above;
                return Math.min(chartH - labelH, below);
            }
        }
        function ecgResolveCollisions(boxes, chartW, chartH) {
            const PAD = 5, ITERS = 120;
            for (let iter = 0; iter < ITERS; iter++) {
                let anyMoved = false;
                for (let i = 0; i < boxes.length; i++) {
                    for (let j = i + 1; j < boxes.length; j++) {
                        const a = boxes[i], b = boxes[j];
                        const aCy = a.y_top_px + a.h_px / 2, bCy = b.y_top_px + b.h_px / 2;
                        const xDist = Math.abs(a.cx_px - b.cx_px), yDist = Math.abs(aCy - bCy);
                        const xNeed = (a.w_px + b.w_px) / 2 + PAD, yNeed = (a.h_px + b.h_px) / 2 + PAD;
                        if (xDist >= xNeed || yDist >= yNeed) continue;
                        anyMoved = true;
                        const xOver = xNeed - xDist, yOver = yNeed - yDist;
                        if (yOver <= xOver) {
                            const h = yOver / 2;
                            if (aCy < bCy) { a.y_top_px -= h; b.y_top_px += h; }
                            else           { a.y_top_px += h; b.y_top_px -= h; }
                        } else {
                            const h = xOver / 2;
                            if (a.cx_px < b.cx_px) { a.cx_px -= h; b.cx_px += h; }
                            else                   { a.cx_px += h; b.cx_px -= h; }
                        }
                        for (const box of [a, b]) {
                            box.y_top_px = Math.max(2, Math.min(chartH - box.h_px - 2, box.y_top_px));
                            box.cx_px    = Math.max(box.w_px / 2 + 4, Math.min(chartW - box.w_px / 2 - 4, box.cx_px));
                        }
                    }
                }
                if (!anyMoved) break;
            }
        }
        function ecgLeaderLine(x1_px, y1_px, x2_px, y2_px, cW, cH, color) {
            const x1 = x1_px / cW * 100, y1 = (cH - y1_px) / cH * 100;
            const x2 = x2_px / cW * 100, y2 = (cH - y2_px) / cH * 100;
            const dx = (x2 - x1) * cW / 100, dy = (y2 - y1) * cH / 100;
            const len = Math.sqrt(dx * dx + dy * dy);
            if (len < 2) return '';
            const ang = Math.atan2(-dy, dx) * 180 / Math.PI;
            return `<div class="ecg-leader" style="left:${x1}%;bottom:${y1}%;width:${len / cW * 100}%;height:1px;background:repeating-linear-gradient(90deg,${color} 0,${color} 3px,transparent 3px,transparent 6px);transform:rotate(${ang}deg);transform-origin:left center;opacity:0.5;"></div>`;
        }

        // â”€â”€ Build label+leader HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildLabelHtml(boxes, cW, cH, isEcg) {
            let html = '';
            // Leaders first (behind labels)
            boxes.forEach(box => {
                const line = ecgLeaderLine(box.cx_px, box.y_top_px + box.h_px / 2, box.dotX_px, box.dotY_px, cW, cH, box.color);
                html += line.replace('class="ecg-leader"', `class="ecg-leader" data-idx="${box.idx}" data-group-idx="${box.groupIndex}"`);
            });
            // Labels
            boxes.forEach(box => {
                const leftPct = box.cx_px / cW * 100;
                const botPct  = (cH - box.y_top_px - box.h_px) / cH * 100;
                const rgb     = box.color.length === 7 ? ecgHexToRgb(box.color) : '0,200,200';
                html += `<div class="ecg-dot-label" data-idx="${box.idx}" data-group-idx="${box.groupIndex}" data-ecg="${isEcg}" `
                    + `style="left:${leftPct}%;bottom:${botPct}%;transform:translateX(-50%);color:${box.color};border-color:rgba(${rgb},.45);">`
                    + `<span class="lbl-mov">${box.movTxt}</span>`
                    + `<span class="lbl-grp">${box.shortN}</span>`
                    + `<span class="lbl-full">${box.fullName}</span>`
                    + `</div>`;
            });
            return html;
        }

        // â”€â”€ Isolation (multi-select legend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toggleIsolate(which, gi) {
            const sel = which === 'Count' ? countIsolated : sumIsolated;
            sel.has(gi) ? sel.delete(gi) : sel.add(gi);
            applyIsolation(which);
            const data = which === 'Count' ? lastCountData : lastSumData;
            if (data) renderLegend(which, data);
        }

        function clearIsolation(which) {
            const sel = which === 'Count' ? countIsolated : sumIsolated;
            if (sel.size === 0) return;
            sel.clear();
            applyIsolation(which);
            const data = which === 'Count' ? lastCountData : lastSumData;
            if (data) renderLegend(which, data);
        }

        function applyIsolation(which) {
            const sel  = which === 'Count' ? countIsolated : sumIsolated;
            const none = sel.size === 0;
            const area = document.getElementById('area' + which);
            if (!area) return;
            area.querySelectorAll('.line-dot[data-group-idx]').forEach(el => {
                el.style.opacity = none || sel.has(+el.dataset.groupIdx) ? '' : '0.07';
            });
            area.querySelectorAll('.line-segment[data-group-idx]').forEach(el => {
                el.style.opacity = none || sel.has(+el.dataset.groupIdx) ? '' : '0.07';
            });
            area.querySelectorAll('.mov-line-seg').forEach(el => {
                el.style.opacity = none ? '' : '0.12';
            });
            area.querySelectorAll('.ecg-dot-label[data-group-idx]').forEach(el => {
                el.style.opacity = none || sel.has(+el.dataset.groupIdx) ? '' : '0.07';
            });
            area.querySelectorAll('.ecg-leader[data-group-idx]').forEach(el => {
                el.style.opacity = none ? '0.5' : sel.has(+el.dataset.groupIdx) ? '0.5' : '0.04';
            });
        }

        // â”€â”€ Hover handler (shared for both charts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function attachChartHover(area, which) {
            function setHover(idx) {
                const cRect = area.getBoundingClientRect();
                area.querySelectorAll('.ecg-dot-label').forEach(el => {
                    const i = +el.dataset.idx;
                    el.classList.remove('ecg-hovered', 'ecg-dimmed');
                    if (i === idx) {
                        const eRect = el.getBoundingClientRect();
                        const oY = eRect.top - cRect.top < 14 ? 'top' : cRect.bottom - eRect.bottom < 14 ? 'bottom' : '50%';
                        const oX = eRect.left - cRect.left < 28 ? 'left' : cRect.right - eRect.right < 28 ? 'right' : '50%';
                        el.style.transformOrigin = `${oX} ${oY}`;
                        el.classList.add('ecg-hovered');
                        el.style.boxShadow = '0 0 0 2px rgba(0,0,0,.96), 0 0 18px ' + el.style.color;
                    } else {
                        el.classList.add('ecg-dimmed');
                        el.style.transformOrigin = '';
                        el.style.boxShadow = '';
                    }
                });
                area.querySelectorAll('.line-dot[data-idx]').forEach(el => {
                    const i = +el.dataset.idx;
                    el.classList.toggle('ecg-hovered', i === idx);
                    if (i !== idx) el.style.opacity = '0.18';
                });
                area.querySelectorAll('.ecg-leader[data-idx]').forEach(el => {
                    const i = +el.dataset.idx;
                    el.classList.remove('ecg-hovered', 'ecg-dimmed');
                    el.classList.add(i === idx ? 'ecg-hovered' : 'ecg-dimmed');
                });
            }
            function clearHover() {
                area.querySelectorAll('.ecg-dot-label').forEach(el => {
                    el.classList.remove('ecg-hovered', 'ecg-dimmed');
                    el.style.transformOrigin = '';
                    el.style.boxShadow = '';
                });
                area.querySelectorAll('.line-dot[data-idx]').forEach(el => {
                    el.classList.remove('ecg-hovered');
                    el.style.opacity = '';
                });
                area.querySelectorAll('.ecg-leader[data-idx]').forEach(el => {
                    el.classList.remove('ecg-hovered', 'ecg-dimmed');
                });
                applyIsolation(which);
            }
            area.addEventListener('mouseover', e => {
                const lbl = e.target.closest('.ecg-dot-label');
                const dot = e.target.closest('.line-dot[data-idx]');
                if (lbl) setHover(+lbl.dataset.idx);
                else if (dot) setHover(+dot.dataset.idx);
            });
            area.addEventListener('mouseout', e => {
                if (e.target.closest('.ecg-dot-label') || e.target.closest('.line-dot[data-idx]')) clearHover();
            });
        }

        // â”€â”€ Legend (clickable, with multi-select state) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderLegend(which, data) {
            const sel    = which === 'Count' ? countIsolated : sumIsolated;
            const isEcg  = which === 'Count' ? countEcg : sumEcg;
            const colors = isEcg ? ecgColors : lineColors;
            const anySelected = sel.size > 0;
            document.getElementById('leg' + which).innerHTML = data.groups.map((g, gi) => {
                const clr = colors[gi % colors.length];
                const isSelected = sel.has(gi);
                const isDimmed   = anySelected && !isSelected;
                const cls = isSelected ? 'legend-item lg-isolated' : isDimmed ? 'legend-item lg-dimmed' : 'legend-item';
                const total = data.group_totals?.[g] || 0;
                const dotGlow   = isEcg ? `box-shadow:0 0 5px ${clr};` : '';
                const dotBorder = isSelected ? `outline:2px solid ${clr};outline-offset:1px;` : '';
                return `<div class="${cls}" onclick="toggleIsolate('${which}',${gi})" `
                     + `${isSelected ? `style="color:${clr};"` : ''} `
                     + `title="${isSelected ? 'Click to deselect' : 'Click to add to selection'}">`
                     + `<div class="legend-dot" style="background:${clr};${dotGlow}${dotBorder}"></div>`
                     + `${g} (${formatNumber(total)})`
                     + (isSelected ? ' <span style="font-size:.7em;opacity:.6;">&#10003;</span>' : '')
                     + `</div>`;
            }).join('');
        }

        // â”€â”€ RAW chart (two-pass rAF: dots first, then lines + labels) â”€â”€â”€â”€â”€â”€â”€â”€
        function renderRawChart(which, data, isEcg) {
            if (rafHandles[which]) { cancelAnimationFrame(rafHandles[which]); rafHandles[which] = null; }

            const area = document.getElementById('area' + which);
            area.style.height = '280px';
            const months = data.months;
            const groups = data.groups;
            const series = data.series;
            const n = months.length;
            const colors = isEcg ? ecgColors : lineColors;
            const pL = 2, pR = 2, uw = 100 - pL - pR;
            const xP = i => n > 1 ? pL + (i / (n - 1)) * uw : 50;

            // Find max
            let rawMax = 0;
            groups.forEach(g => { (series[g] || []).forEach(v => { if (v > rawMax) rawMax = v; }); });
            const nm = getNiceMax(rawMax * 1.05, 6);
            const yP = v => nm > 0 ? (v / nm) * 100 : 0;
            const gclr = isEcg ? 'rgba(0,80,0,.5)' : '#ecf0f1';

            // Build flat points array
            const rawPts = [];
            groups.forEach((g, gi) => {
                const vals = series[g] || [];
                vals.forEach((v, mi) => {
                    rawPts.push({ x: xP(mi), y: yP(v), value: v, group: g, groupIndex: gi, monthIndex: mi, idx: gi * n + mi });
                });
            });

            // Pass 1: grid + dots
            let html = '';
            for (let i = 0; i <= 6; i++) html += `<div class="line-chart-grid-line" style="bottom:${(i / 6) * 100}%;background:${gclr};"></div>`;
            rawPts.forEach(p => {
                const clr = colors[p.groupIndex % colors.length];
                const gw = isEcg ? `box-shadow:0 0 6px ${clr};` : '';
                html += `<div class="line-dot" data-idx="${p.idx}" data-group-idx="${p.groupIndex}" `
                    + `style="left:${p.x}%;bottom:${p.y}%;background:${clr};border-color:${isEcg ? '#0a0a0a' : '#fff'};${gw}"></div>`;
            });
            area.innerHTML = html;

            // Y labels
            let yh = '';
            for (let i = 0; i <= 6; i++) { const v = nm / 6 * i; yh += `<div class="line-chart-y-label" style="position:absolute;bottom:${yP(v)}%;">${fmtY(Math.round(v))}</div>`; }
            document.getElementById('yl' + which).innerHTML = yh;
            const xl = document.getElementById('xl' + which);
            xl.className = 'line-chart-x-labels';
            xl.innerHTML = months.map(m => `<div class="line-chart-x-label">${formatMonth(m)}</div>`).join('');

            // Summary
            const totals = groups.map((g, gi) => ({ name: g, total: (series[g] || []).reduce((a, b) => a + b, 0) })).sort((a, b) => b.total - a.total);
            document.getElementById('sum' + which).textContent = `Top: ${totals[0]?.name || '-'} (${fmtY(totals[0]?.total || 0)})  Â·  ${groups.length} groups`;

            renderLegend(which, data);

            // Pass 2: pixel-accurate lines + collision-free labels + hover + isolation
            rafHandles[which] = requestAnimationFrame(() => {
                rafHandles[which] = null;
                const cW = area.offsetWidth || 900, cH = area.offsetHeight || 280;
                let extra = '';

                // Lines with data-group-idx
                groups.forEach((g, gi) => {
                    const clr = colors[gi % colors.length];
                    const gw = isEcg ? `box-shadow:0 0 6px ${clr};` : '';
                    const vals = series[g] || [];
                    for (let i = 0; i < n - 1; i++) {
                        const x1 = xP(i), y1 = yP(vals[i] || 0), x2 = xP(i + 1), y2 = yP(vals[i + 1] || 0);
                        const dx = (x2 - x1) * cW / 100, dy = (y2 - y1) * cH / 100;
                        const len = Math.sqrt(dx * dx + dy * dy), ang = Math.atan2(-dy, dx) * 180 / Math.PI;
                        extra += `<div class="line-segment" data-group-idx="${gi}" `
                            + `style="left:${x1}%;bottom:${y1}%;width:${len / cW * 100}%;background:${clr};transform:rotate(${ang}deg);${gw}"></div>`;
                    }
                });

                // Collision-free labels
                const LBL_H = 28, LBL_CH = 7.2, GAP = 12;
                const boxes = rawPts.map(p => {
                    const movTxt = fmtY(p.value);
                    const shortN = p.group.split(' ')[0];
                    const w_px = Math.max(movTxt.length, shortN.length) * LBL_CH + 18;
                    const dotX_px = p.x * cW / 100;
                    const dotY_px = cH - p.y * cH / 100;
                    return { cx_px: dotX_px, y_top_px: ecgPreferredTop(dotY_px, 1, LBL_H, GAP, cH),
                        w_px, h_px: LBL_H, dotX_px, dotY_px,
                        color: colors[p.groupIndex % colors.length], groupIndex: p.groupIndex,
                        movTxt, shortN, fullName: p.group, idx: p.idx };
                });
                ecgResolveCollisions(boxes, cW, cH);
                extra += buildLabelHtml(boxes, cW, cH, isEcg);

                area.insertAdjacentHTML('beforeend', extra);
                attachChartHover(area, which);
                applyIsolation(which);
            });
        }

        // â”€â”€ MOVEMENT chart (sequential pulse) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderMovementChart(which, data, isEcg) {
            if (rafHandles[which]) { cancelAnimationFrame(rafHandles[which]); rafHandles[which] = null; }

            const area = document.getElementById('area' + which);
            area.style.height = '350px';
            const cW = area.offsetWidth || 900, cH = 350;
            const months = data.months;
            const groups = data.groups;
            const movSeries = data.movement_series;
            const rawSeries = data.series;
            const baselineMonth = data.baseline_month;
            const n = months.length, ng = groups.length;
            const colors = isEcg ? ecgColors : lineColors;
            const lineColor = isEcg ? '#00ff41' : '#95a5a6';
            const gclr = isEcg ? 'rgba(0,80,0,.5)' : '#ecf0f1';

            // Flat points
            const points = [];
            for (let mi = 0; mi < n; mi++)
                for (let gi = 0; gi < ng; gi++)
                    points.push({
                        value: (movSeries[groups[gi]] || [])[mi] || 0,
                        rawValue: (rawSeries[groups[gi]] || [])[mi] || 0,
                        group: groups[gi], groupIndex: gi, monthIndex: mi, idx: mi * ng + gi
                    });
            const totalPoints = points.length;

            const maxAbs = Math.max(...points.map(p => Math.abs(p.value)));
            const nm = getNiceMaxBipolar(maxAbs) || 1;

            const pL = 2, pR = 2, uw = 100 - pL - pR;
            const idxToX = i => totalPoints > 1 ? pL + (i / (totalPoints - 1)) * uw : 50;
            const valToY = v => nm > 0 ? ((v + nm) / (2 * nm)) * 100 : 50;

            // Y labels
            let yh = '';
            for (let i = 0; i <= 6; i++) { const frac = i / 6; const val = -nm + (2 * nm * frac); yh += `<div class="line-chart-y-label" style="position:absolute;bottom:${frac * 100}%;">${fmtMov(val)}</div>`; }
            document.getElementById('yl' + which).innerHTML = yh;

            let html = '';
            for (let i = 0; i <= 6; i++) html += `<div class="line-chart-grid-line" style="bottom:${(i / 6) * 100}%;background:${gclr};"></div>`;
            html += `<div class="ecg-baseline-line" style="bottom:50%;"><span class="ecg-baseline-label">Baseline: ${formatMonth(baselineMonth)}</span></div>`;

            // Month separators
            for (let mi = 1; mi < n; mi++) {
                const si = mi * ng, sepX = (idxToX(si - 1) + idxToX(si)) / 2;
                html += `<div class="ecg-month-sep" style="left:${sepX}%;"></div>`;
            }

            // ONE continuous line (class mov-line-seg â€” no group-idx; whole line dims on isolation)
            for (let i = 0; i < totalPoints - 1; i++) {
                const x1 = idxToX(i), y1 = valToY(points[i].value), x2 = idxToX(i + 1), y2 = valToY(points[i + 1].value);
                const pxDx = (x2 - x1) * cW / 100, pxDy = (y2 - y1) * cH / 100;
                const pxLen = Math.sqrt(pxDx * pxDx + pxDy * pxDy);
                const gw = isEcg ? `box-shadow:0 0 6px ${lineColor};` : '';
                html += `<div class="line-segment mov-line-seg" style="left:${x1}%;bottom:${y1}%;width:${pxLen / cW * 100}%;background:${lineColor};transform:rotate(${Math.atan2(-pxDy, pxDx) * 180 / Math.PI}deg);${gw}"></div>`;
            }

            // Collision-free labels
            const LBL_H = 32, LBL_CH = 7.2, GAP = 14;
            const boxes = points.map((p, i) => {
                const movTxt = fmtMov(p.value);
                const shortN = p.group.split(' ')[0];
                const rawTxt = fmtY(p.rawValue);
                const w_px = Math.max(movTxt.length, shortN.length) * LBL_CH + 18;
                const dotX_px = idxToX(i) * cW / 100;
                const dotY_px = cH - valToY(p.value) * cH / 100;
                return { cx_px: dotX_px, y_top_px: ecgPreferredTop(dotY_px, p.value, LBL_H, GAP, cH),
                    w_px, h_px: LBL_H, dotX_px, dotY_px,
                    color: colors[p.groupIndex % colors.length], groupIndex: p.groupIndex,
                    movTxt, shortN: `${shortN}: ${rawTxt}`, fullName: p.group, idx: p.idx };
            });
            ecgResolveCollisions(boxes, cW, cH);
            html += buildLabelHtml(boxes, cW, cH, isEcg);

            // Dots (after labels/leaders in DOM)
            points.forEach((p, i) => {
                const x = idxToX(i), y = valToY(p.value);
                const clr = colors[p.groupIndex % colors.length];
                const gw = isEcg ? `box-shadow:0 0 8px ${clr};` : '';
                html += `<div class="line-dot" data-idx="${p.idx}" data-group-idx="${p.groupIndex}" `
                    + `style="left:${x}%;bottom:${y}%;background:${clr};border-color:${isEcg ? '#0a0a0a' : '#fff'};z-index:10;${gw}"></div>`;
            });

            area.innerHTML = html;
            attachChartHover(area, which);
            applyIsolation(which);

            // X labels
            const xl = document.getElementById('xl' + which);
            xl.className = 'line-chart-x-labels ecg-mode';
            let xHtml = '';
            for (let mi = 0; mi < n; mi++) {
                const si = mi * ng, cx = (idxToX(si) + idxToX(si + ng - 1)) / 2;
                const isBase = months[mi] === baselineMonth;
                xHtml += `<div class="${isBase ? 'ecg-x-label baseline-highlight' : 'ecg-x-label'}" style="left:${cx}%;">${formatMonth(months[mi])}${isBase ? ' (BASELINE)' : ''}</div>`;
            }
            xl.innerHTML = xHtml;

            // Summary
            const last = points.filter(p => p.monthIndex === n - 1).map(p => ({ name: p.group, mov: p.value })).sort((a, b) => b.mov - a.mov);
            document.getElementById('sum' + which).textContent = last.length > 0
                ? `Latest month vs baseline â€” Top gain: ${last[0].name} (${fmtMov(last[0].mov)})`
                : '';

            renderLegend(which, data);
        }

        // â”€â”€ Chart renderers per card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderCountChart(data) {
            renderRawChart('Count', data, countEcg);
        }

        function renderSumChart(data) {
            if (sumChartMode === 'movement' && data.movement_series) {
                renderMovementChart('Sum', data, sumEcg);
            } else {
                renderRawChart('Sum', data, sumEcg);
            }
        }

        // â”€â”€ ESC key handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { clearIsolation('Count'); clearIsolation('Sum'); }
        });

        // â”€â”€ Show/Specific toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function onShowChange() {
            const showVal = document.getElementById('trendShowSelect').value;
            const chipRow = document.getElementById('chipRow');
            if (showVal === '0') {
                chipRow.style.display = 'flex';
                loadUniqueGroups();
            } else {
                chipRow.style.display = 'none';
                selectedSpecificGroups = [];
                renderChips();
                onTrendControlChange();
            }
        }

        async function loadUniqueGroups() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const trendStart = document.getElementById('trendStartDate').value || startDate;
            const trendEnd = document.getElementById('trendEndDate').value || endDate;
            const groupCol = document.getElementById('trendGroupSelect')?.value;
            if (!startDate || !endDate || !groupCol) return;
            try {
                const url = `/api/trend-line-data?start_date=${startDate}&end_date=${endDate}&trend_start_date=${trendStart}&trend_end_date=${trendEnd}&group_column=${encodeURIComponent(groupCol)}&top_n=0`;
                const resp = await fetch(url);
                const data = await resp.json();
                if (data.success && data.available_groups) allGroupValues = data.available_groups;
            } catch (e) {
                console.error('Error loading unique groups:', e);
            }
        }

        // â”€â”€ Dual-fetch trend control change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function onTrendControlChange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const groupCol = document.getElementById('trendGroupSelect')?.value;

            if (!startDate || !endDate || !groupCol) {
                document.getElementById('trendSection').style.display = 'none';
                return;
            }

            const topN = document.getElementById('trendShowSelect').value;
            const valueCol = document.getElementById('trendValueSelect')?.value || '';
            const trendStart = document.getElementById('trendStartDate').value || startDate;
            const trendEnd = document.getElementById('trendEndDate').value || endDate;
            const baselineMonth = sumChartMode === 'movement' ? (document.getElementById('baselineMonthSelect').value || '') : '';

            // If Specific mode with no groups selected, show section but no chart
            if (topN === '0' && selectedSpecificGroups.length === 0) {
                document.getElementById('trendSection').style.display = 'block';
                ['Count', 'Sum'].forEach(w => {
                    document.getElementById('area' + w).innerHTML = '<div class="no-data">Search and add groups above to see trend</div>';
                    document.getElementById('xl' + w).innerHTML = '';
                    document.getElementById('yl' + w).innerHTML = '';
                    document.getElementById('leg' + w).innerHTML = '';
                    document.getElementById('sum' + w).textContent = '';
                });
                lastCountData = null;
                lastSumData   = null;
                return;
            }

            // Build shared params
            let baseParams = `start_date=${startDate}&end_date=${endDate}&group_column=${encodeURIComponent(groupCol)}&top_n=${topN}`;
            baseParams += `&trend_start_date=${trendStart}&trend_end_date=${trendEnd}`;
            if (topN === '0') {
                selectedSpecificGroups.forEach(g => { baseParams += `&specific_groups=${encodeURIComponent(g)}`; });
            }

            // COUNT URL (always count, no baseline)
            const countUrl = `/api/trend-line-data?${baseParams}&agg_method=count`;
            // SUM URL
            let sumUrl = `/api/trend-line-data?${baseParams}&agg_method=sum`;
            if (valueCol) sumUrl += `&value_column=${encodeURIComponent(valueCol)}`;
            if (baselineMonth) sumUrl += `&baseline_month=${encodeURIComponent(baselineMonth)}`;

            try {
                const [countResp, sumResp] = await Promise.all([fetch(countUrl), fetch(sumUrl)]);
                const countData = await countResp.json();
                const sumData   = await sumResp.json();

                document.getElementById('trendSection').style.display = 'block';

                // COUNT chart
                if (countData.success && countData.months?.length > 0 && countData.groups?.length > 0) {
                    lastCountData = countData;
                    renderCountChart(countData);
                } else {
                    lastCountData = null;
                    document.getElementById('areaCount').innerHTML = '<div class="no-data">No data available</div>';
                    document.getElementById('xlCount').innerHTML = '';
                    document.getElementById('ylCount').innerHTML = '';
                    document.getElementById('legCount').innerHTML = '';
                    document.getElementById('sumCount').textContent = '';
                }

                // SUM chart
                if (sumData.success && sumData.months?.length > 0 && sumData.groups?.length > 0) {
                    lastSumData = sumData;
                    // Populate baseline month dropdown
                    populateBaselineMonths(sumData.months);
                    renderSumChart(sumData);
                } else {
                    lastSumData = null;
                    document.getElementById('areaSum').innerHTML = '<div class="no-data">No data available</div>';
                    document.getElementById('xlSum').innerHTML = '';
                    document.getElementById('ylSum').innerHTML = '';
                    document.getElementById('legSum').innerHTML = '';
                    document.getElementById('sumSum').textContent = '';
                }
            } catch (e) {
                console.error('Error loading trend line data:', e);
            }
            saveUiState();
        }

        function downloadTrendLineExcel(which) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const groupCol = document.getElementById('trendGroupSelect')?.value;
            if (!startDate || !endDate || !groupCol) return;

            const topN = document.getElementById('trendShowSelect').value;
            const trendStart = document.getElementById('trendStartDate').value || startDate;
            const trendEnd = document.getElementById('trendEndDate').value || endDate;

            let aggMethod, valueCol, baselineMonth;
            if (which === 'Count') {
                aggMethod = 'count';
                valueCol = '';
                baselineMonth = '';
            } else {
                aggMethod = 'sum';
                valueCol = document.getElementById('trendValueSelect')?.value || '';
                baselineMonth = sumChartMode === 'movement' ? (document.getElementById('baselineMonthSelect').value || '') : '';
            }

            let url = `/api/download-trend-line?start_date=${startDate}&end_date=${endDate}&group_column=${encodeURIComponent(groupCol)}&agg_method=${aggMethod}&top_n=${topN}`;
            url += `&trend_start_date=${trendStart}&trend_end_date=${trendEnd}`;
            if (baselineMonth) url += `&baseline_month=${encodeURIComponent(baselineMonth)}`;
            if (valueCol) url += `&value_column=${encodeURIComponent(valueCol)}`;
            if (topN === '0') {
                selectedSpecificGroups.forEach(g => { url += `&specific_groups=${encodeURIComponent(g)}`; });
            }
            window.location.href = url;
        }

        // === Chip search functions ===
        function focusChipSearch() {
            document.getElementById('chipSearchInput').focus();
        }

        function onChipSearchInput() {
            const val = document.getElementById('chipSearchInput').value;
            renderChipDropdown(val);
            showChipDropdown();
        }

        function showChipDropdown() {
            const dd = document.getElementById('chipDropdown');
            renderChipDropdown(document.getElementById('chipSearchInput').value);
            dd.style.display = 'block';
        }

        function hideChipDropdown() {
            document.getElementById('chipDropdown').style.display = 'none';
        }

        function renderChipDropdown(filter) {
            const dd = document.getElementById('chipDropdown');
            const lower = (filter || '').toLowerCase();
            const filtered = allGroupValues.filter(g =>
                !selectedSpecificGroups.includes(g) && (!lower || g.toLowerCase().includes(lower))
            ).slice(0, 50);

            if (filtered.length === 0) {
                dd.innerHTML = '<div class="chip-option" style="color:#999;cursor:default;">No matches</div>';
                return;
            }

            dd.innerHTML = filtered.map(g => {
                const escaped = g.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                return `<div class="chip-option" onclick="addChip('${escaped.replace(/'/g, "\\'")}')">${escaped}</div>`;
            }).join('');
        }

        function addChip(name) {
            // Decode HTML entities back
            const decoded = name.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&quot;/g, '"');
            if (!selectedSpecificGroups.includes(decoded)) {
                selectedSpecificGroups.push(decoded);
                renderChips();
                document.getElementById('chipSearchInput').value = '';
                hideChipDropdown();
                onTrendControlChange();
            }
        }

        function removeChip(name) {
            selectedSpecificGroups = selectedSpecificGroups.filter(g => g !== name);
            renderChips();
            onTrendControlChange();
        }

        function renderChips() {
            const container = document.getElementById('chipContainer');
            container.innerHTML = selectedSpecificGroups.map(g => {
                const escaped = g.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                return `<span class="chip">${escaped}<span class="chip-remove" onclick="event.stopPropagation();removeChip('${escaped.replace(/'/g, "\\'")}')">&times;</span></span>`;
            }).join('');
        }

        // Close chip dropdown on outside click
        document.addEventListener('click', function(e) {
            const wrapper = document.querySelector('.chip-input-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                hideChipDropdown();
            }
        });

        let chartViewMode = 'bar'; // 'bar' or 'list'

        function updateChart(chartId, chartData, label) {
            const chart = document.getElementById(chartId);
            if (!chart) return;

            if (chartData && Object.keys(chartData).length > 0) {
                const entries = Object.entries(chartData).sort((a, b) => b[1] - a[1]);
                const maxValue = entries[0][1];

                if (chartViewMode === 'bar') {
                    chart.innerHTML = entries.map(([name, count], index) => {
                        const percentage = (count / maxValue) * 100;
                        return `
                            <div class="bar-chart-item">
                                <span class="bar-label" title="${name}">${name}</span>
                                <div class="bar-container">
                                    <div class="bar-fill bar-fill-${(index % 10) + 1}" style="width: ${percentage}%">
                                        ${count.toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    chart.innerHTML = entries.map(([name, count]) => `
                        <div class="data-item">
                            <span class="data-name" title="${name}">${name}</span>
                            <span class="data-count">${count.toLocaleString()} records</span>
                        </div>
                    `).join('');
                }
            } else {
                chart.innerHTML = `<div class="no-data">No ${label} data available for selected period</div>`;
            }
        }

        function toggleChartView(mode) {
            chartViewMode = mode;
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            loadDashboard();
        }

        async function downloadFiltered() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showMessage('Please select both start and end dates', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('Start date must be before end date', 'error');
                return;
            }

            // Check if running in PyWebView (has pywebview API)
            if (window.pywebview && window.pywebview.api) {
                try {
                    showMessage('Preparing download...', 'success');
                    const result = await window.pywebview.api.save_filtered_file(startDate, endDate);
                    if (result.success) {
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.error, 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            } else {
                // Fallback for browser mode - use CSV for speed
                showMessage('Downloading filtered data (CSV)...', 'success');
                window.location.href = `/api/download-filtered?start_date=${startDate}&end_date=${endDate}&format=csv`;
            }
        }

        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';

            if (type === 'success') {
                setTimeout(hideMessage, 3000);
            }
        }

        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeToggle').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('darkMode', isDark ? 'true' : 'false');
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('themeToggle').textContent = 'â˜€ï¸';
        }

        // (Trend modal removed â€” inline line chart replaces it)

        // Comparison View
        let lastComparisonParams = null;

        async function showComparison() {
            // Toggle: if already open, close it
            const existing = document.getElementById('comparisonModal');
            if (existing) {
                existing.remove();
                return;
            }

            const columnOptions = availableColumns.map(col =>
                `<option value="${col}">${col}</option>`
            ).join('');

            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'comparisonModal';

            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>Compare Periods</h2>
                        <button class="modal-close" onclick="closeComparisonModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="comparison-container">
                            <div class="comparison-period">
                                <div class="comparison-header">Period 1</div>
                                <div class="form-group">
                                    <label>Start</label>
                                    <input type="date" id="comp1Start" value="${minDate || ''}" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                                <div class="form-group" style="margin-top:10px;">
                                    <label>End</label>
                                    <input type="date" id="comp1End" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                            </div>
                            <div class="comparison-period">
                                <div class="comparison-header">Period 2</div>
                                <div class="form-group">
                                    <label>Start</label>
                                    <input type="date" id="comp2Start" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                                <div class="form-group" style="margin-top:10px;">
                                    <label>End</label>
                                    <input type="date" id="comp2End" value="${maxDate || ''}" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:15px;">
                            <label>Compare Column (optional)</label>
                            <select id="compColumnSelect" style="width:100%;padding:10px;border:1px solid #dce1e5;border-radius:6px;font-size:1em;">
                                <option value="">-- Select Column to Compare --</option>
                                ${columnOptions}
                            </select>
                        </div>
                        <div id="comparisonResults" style="margin-top: 20px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeComparisonModal()">Close</button>
                        <button class="btn btn-success" onclick="runComparison()">Compare</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Toggle date picker on click for comparison modal inputs
            modal.querySelectorAll('input[type="date"]').forEach(input => {
                let pickerOpen = false;
                input.addEventListener('click', (e) => {
                    if (pickerOpen) {
                        e.preventDefault();
                        input.blur();
                        pickerOpen = false;
                    } else {
                        pickerOpen = true;
                    }
                });
                input.addEventListener('blur', () => { pickerOpen = false; });
                input.addEventListener('change', () => { pickerOpen = false; });
            });
        }

        async function runComparison() {
            const period1 = {
                start: document.getElementById('comp1Start').value,
                end: document.getElementById('comp1End').value
            };
            const period2 = {
                start: document.getElementById('comp2Start').value,
                end: document.getElementById('comp2End').value
            };

            if (!period1.start || !period1.end || !period2.start || !period2.end) {
                alert('Please fill in all dates');
                return;
            }

            const compColumn = document.getElementById('compColumnSelect').value;

            try {
                const fetchPromises = [
                    fetch(`/api/dashboard-stats?start_date=${period1.start}&end_date=${period1.end}`),
                    fetch(`/api/dashboard-stats?start_date=${period2.start}&end_date=${period2.end}`)
                ];

                if (compColumn) {
                    fetchPromises.push(
                        fetch(`/api/compare-column?column=${encodeURIComponent(compColumn)}&start1=${period1.start}&end1=${period1.end}&start2=${period2.start}&end2=${period2.end}`)
                    );
                }

                const responses = await Promise.all(fetchPromises);
                const data1 = await responses[0].json();
                const data2 = await responses[1].json();

                const change = data2.total_records - data1.total_records;
                const changePercent = data1.total_records > 0 ? ((change / data1.total_records) * 100).toFixed(1) : 0;

                let resultsHTML = `
                    <div class="comparison-container">
                        <div class="comparison-period" style="text-align: center;">
                            <div class="comparison-header">Period 1</div>
                            <div class="comparison-value">${data1.total_records.toLocaleString()}</div>
                            <div style="color:#7f8c8d;font-size:0.85em;">${formatDate(period1.start)} to ${formatDate(period1.end)}</div>
                        </div>
                        <div class="comparison-period" style="text-align: center;">
                            <div class="comparison-header">Period 2</div>
                            <div class="comparison-value">${data2.total_records.toLocaleString()}</div>
                            <div style="color:#7f8c8d;font-size:0.85em;">${formatDate(period2.start)} to ${formatDate(period2.end)}</div>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px;">
                        <div style="font-size:1.2em;font-weight:600;">
                            Change: <span class="${change >= 0 ? 'comparison-change positive' : 'comparison-change negative'}">
                                ${change >= 0 ? '+' : ''}${change.toLocaleString()} (${change >= 0 ? '+' : ''}${changePercent}%)
                            </span>
                        </div>
                    </div>
                `;

                if (compColumn && responses[2]) {
                    const compData = await responses[2].json();
                    if (compData.success && compData.comparison.length > 0) {
                        resultsHTML += renderComparisonTable(compData.comparison);

                        lastComparisonParams = {
                            column: compColumn,
                            start1: period1.start, end1: period1.end,
                            start2: period2.start, end2: period2.end
                        };

                        // Also populate the dashboard comparison section
                        const section = document.getElementById('comparisonSection');
                        if (section) {
                            section.style.display = 'block';
                            document.getElementById('comparisonTitle').textContent = `Period Comparison: ${compColumn}`;
                            document.getElementById('comparisonTableContainer').innerHTML = renderComparisonTable(compData.comparison);
                        }
                    }
                }

                const resultsEl = document.getElementById('comparisonResults');
                if (resultsEl) resultsEl.innerHTML = resultsHTML;
            } catch (error) {
                alert('Error comparing periods: ' + error.message);
            }
        }

        function renderComparisonTable(comparison) {
            return `
                <div style="margin-top:15px;max-height:400px;overflow-y:auto;">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Value</th>
                                <th>Period 1</th>
                                <th>Period 2</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${comparison.map((row, i) => {
                                const changeClass = row.change_pct > 0 ? 'change-positive' : (row.change_pct < 0 ? 'change-negative' : 'change-neutral');
                                const changeText = `${row.change_pct > 0 ? '+' : ''}${row.change_pct}%`;
                                return `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${row.value}</td>
                                        <td>${row.count1.toLocaleString()}</td>
                                        <td>${row.count2.toLocaleString()}</td>
                                        <td class="${changeClass}">${changeText}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function downloadComparison() {
            if (!lastComparisonParams) {
                showMessage('Run a comparison with a column selected first', 'error');
                return;
            }
            const p = lastComparisonParams;
            try {
                const response = await fetch(`/api/download-comparison?column=${encodeURIComponent(p.column)}&start1=${p.start1}&end1=${p.end1}&start2=${p.start2}&end2=${p.end2}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Comparison_${p.column}_${p.start1}_to_${p.end2}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessage('Comparison downloaded', 'success');
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Download failed', 'error');
                }
            } catch (error) {
                showMessage('Error downloading comparison: ' + error.message, 'error');
            }
        }

        function closeComparisonModal() {
            const modal = document.getElementById('comparisonModal');
            if (modal) modal.remove();
        }

        // Advanced Comparative Analysis
        function showAdvancedAnalysis() {
            // Toggle: if already open, close it
            const existing = document.getElementById('advancedAnalysisModal');
            if (existing) {
                existing.remove();
                return;
            }

            const dateColumnOptions = dateColumns.map(col =>
                `<option value="${col}" ${col === currentSettings.date_column ? 'selected' : ''}>${col}</option>`
            ).join('');

            const groupColumnOptions = availableColumns.map(col =>
                `<option value="${col}">${col}</option>`
            ).join('');

            const valueColumnOptions = numericColumns.map(col =>
                `<option value="${col}">${col}</option>`
            ).join('');

            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'advancedAnalysisModal';

            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header" style="background:#16a085;">
                        <h2>Advanced Comparative Analysis</h2>
                        <button class="modal-close" onclick="closeAdvancedAnalysisModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                            <div class="form-group">
                                <label>Date Column</label>
                                <select id="advDateColumn" style="width:100%;padding:10px;border:1px solid #dce1e5;border-radius:6px;font-size:1em;">
                                    <option value="">-- Select Date Column --</option>
                                    ${dateColumnOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Group By Column</label>
                                <select id="advGroupColumn" style="width:100%;padding:10px;border:1px solid #dce1e5;border-radius:6px;font-size:1em;">
                                    <option value="">-- Select Column --</option>
                                    ${groupColumnOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Value Column (Numeric)</label>
                                <select id="advValueColumn" style="width:100%;padding:10px;border:1px solid #dce1e5;border-radius:6px;font-size:1em;">
                                    <option value="">-- Select Numeric Column --</option>
                                    ${valueColumnOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Aggregation Method</label>
                                <select id="advAggMethod" style="width:100%;padding:10px;border:1px solid #dce1e5;border-radius:6px;font-size:1em;">
                                    <option value="sum">SUM</option>
                                    <option value="count">COUNT</option>
                                    <option value="average">AVERAGE</option>
                                    <option value="min">MIN</option>
                                    <option value="max">MAX</option>
                                </select>
                            </div>
                        </div>
                        <div class="comparison-container" style="margin-top:20px;">
                            <div class="comparison-period">
                                <div class="comparison-header">Period 1</div>
                                <div class="form-group">
                                    <label>Start</label>
                                    <input type="date" id="adv1Start" value="${minDate || ''}" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                                <div class="form-group" style="margin-top:10px;">
                                    <label>End</label>
                                    <input type="date" id="adv1End" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                            </div>
                            <div class="comparison-period">
                                <div class="comparison-header">Period 2</div>
                                <div class="form-group">
                                    <label>Start</label>
                                    <input type="date" id="adv2Start" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                                <div class="form-group" style="margin-top:10px;">
                                    <label>End</label>
                                    <input type="date" id="adv2End" value="${maxDate || ''}" min="${minDate || ''}" max="${maxDate || ''}">
                                </div>
                            </div>
                        </div>
                        <div id="advancedResults" style="margin-top:20px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAdvancedAnalysisModal()">Close</button>
                        <button class="btn btn-success" onclick="runAdvancedAnalysis()">Analyze</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Toggle date picker on click for advanced modal inputs
            modal.querySelectorAll('input[type="date"]').forEach(input => {
                let pickerOpen = false;
                input.addEventListener('click', (e) => {
                    if (pickerOpen) {
                        e.preventDefault();
                        input.blur();
                        pickerOpen = false;
                    } else {
                        pickerOpen = true;
                    }
                });
                input.addEventListener('blur', () => { pickerOpen = false; });
                input.addEventListener('change', () => { pickerOpen = false; });
            });
        }

        async function runAdvancedAnalysis() {
            const dateCol = document.getElementById('advDateColumn').value;
            const groupCol = document.getElementById('advGroupColumn').value;
            const valueCol = document.getElementById('advValueColumn').value;
            const aggMethod = document.getElementById('advAggMethod').value;
            const start1 = document.getElementById('adv1Start').value;
            const end1 = document.getElementById('adv1End').value;
            const start2 = document.getElementById('adv2Start').value;
            const end2 = document.getElementById('adv2End').value;

            if (!dateCol || !groupCol || !valueCol) {
                alert('Please select Date Column, Group By Column, and Value Column');
                return;
            }
            if (!start1 || !end1 || !start2 || !end2) {
                alert('Please fill in all date fields for both periods');
                return;
            }

            const resultsDiv = document.getElementById('advancedResults');
            resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:#7f8c8d;"><div class="spinner"></div>Running analysis...</div>';

            try {
                const params = new URLSearchParams({
                    date_column: dateCol, group_column: groupCol, value_column: valueCol,
                    agg_method: aggMethod, start1, end1, start2, end2
                });
                const response = await fetch(`/api/advanced-analysis?${params}`);
                const data = await response.json();

                if (data.success) {
                    const p1Label = `${formatDate(start1)} to ${formatDate(end1)}`;
                    const p2Label = `${formatDate(start2)} to ${formatDate(end2)}`;

                    let html = `
                        <div class="comparison-container">
                            <div class="comparison-period" style="text-align:center;">
                                <div class="comparison-header">Period 1</div>
                                <div style="color:#7f8c8d;font-size:0.85em;">${p1Label}</div>
                                <div style="font-size:1.2em;font-weight:600;margin-top:5px;">${data.period1.rows.toLocaleString()} rows</div>
                            </div>
                            <div class="comparison-period" style="text-align:center;">
                                <div class="comparison-header">Period 2</div>
                                <div style="color:#7f8c8d;font-size:0.85em;">${p2Label}</div>
                                <div style="font-size:1.2em;font-weight:600;margin-top:5px;">${data.period2.rows.toLocaleString()} rows</div>
                            </div>
                        </div>
                        <div style="text-align:center;margin-top:10px;padding:10px;background:#f8f9fa;border-radius:6px;font-size:0.9em;color:#7f8c8d;">
                            <strong>${aggMethod.toUpperCase()}</strong> of <strong>${valueCol}</strong> grouped by <strong>${groupCol}</strong>
                        </div>
                    `;

                    if (data.comparison.length > 0) {
                        html += renderAdvancedTable(data.comparison, groupCol, aggMethod, p1Label, p2Label);
                    } else {
                        html += '<div class="no-data" style="margin-top:15px;">No data found for the selected parameters</div>';
                    }

                    resultsDiv.innerHTML = html;

                    // Store params for download
                    lastAdvancedParams = { date_column: dateCol, group_column: groupCol, value_column: valueCol, agg_method: aggMethod, start1, end1, start2, end2 };

                    // Populate inline section
                    const section = document.getElementById('advancedAnalysisSection');
                    section.style.display = 'block';
                    document.getElementById('advancedAnalysisTitle').textContent = `Advanced Analysis: ${aggMethod.toUpperCase()}(${valueCol}) by ${groupCol}`;
                    document.getElementById('advancedAnalysisTableContainer').innerHTML = data.comparison.length > 0
                        ? renderAdvancedTable(data.comparison, groupCol, aggMethod, p1Label, p2Label)
                        : '<div class="no-data">No data found</div>';
                } else {
                    resultsDiv.innerHTML = `<div style="color:#e74c3c;text-align:center;padding:15px;">${data.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color:#e74c3c;text-align:center;padding:15px;">Error: ${error.message}</div>`;
            }
        }

        function renderAdvancedTable(comparison, groupColumn, aggMethod, p1Label, p2Label) {
            return `
                <div style="margin-top:15px;max-height:400px;overflow-y:auto;">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>${groupColumn}</th>
                                <th>${aggMethod.toUpperCase()} (P1)</th>
                                <th>${aggMethod.toUpperCase()} (P2)</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${comparison.map((row, i) => {
                                const changeClass = row.change_pct > 0 ? 'change-positive' : (row.change_pct < 0 ? 'change-negative' : 'change-neutral');
                                const changeText = `${row.change_pct > 0 ? '+' : ''}${row.change_pct}%`;
                                return `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${row.group}</td>
                                        <td>${Number(row.value1).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2})}</td>
                                        <td>${Number(row.value2).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2})}</td>
                                        <td class="${changeClass}">${changeText}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function downloadAdvancedAnalysis() {
            if (!lastAdvancedParams) {
                showMessage('Run an advanced analysis first', 'error');
                return;
            }
            const p = lastAdvancedParams;
            try {
                const params = new URLSearchParams(p);
                const response = await fetch(`/api/download-advanced-analysis?${params}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Advanced_Analysis_${p.group_column}_${p.agg_method}_${p.start1}_to_${p.end2}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessage('Advanced analysis downloaded', 'success');
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Download failed', 'error');
                }
            } catch (error) {
                showMessage('Error downloading: ' + error.message, 'error');
            }
        }

        function closeAdvancedAnalysisModal() {
            const modal = document.getElementById('advancedAnalysisModal');
            if (modal) modal.remove();
        }

        // Column Statistics (inline)
        async function loadColumnStats() {
            try {
                const res = await fetch('/api/column-stats');
                const data = await res.json();

                if (data.success && data.columns.length > 0) {
                    document.getElementById('columnStatsCard').style.display = 'block';
                    document.getElementById('columnStatsContent').innerHTML = `
                        <div style="overflow-x: auto;">
                            <table style="width:100%;border-collapse:collapse;font-size:0.9em;">
                                <thead>
                                    <tr style="background:#34495e;color:white;">
                                        <th style="padding:10px;text-align:left;">Column</th>
                                        <th style="padding:10px;text-align:left;">Type</th>
                                        <th style="padding:10px;text-align:right;">Filled %</th>
                                        <th style="padding:10px;text-align:right;">Unique</th>
                                        <th style="padding:10px;text-align:center;">Duplicates</th>
                                        <th style="padding:10px;text-align:left;">Sample Values</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.columns.map(col => {
                                        const hasDuplicates = col.unique_count < data.total_rows;
                                        return `
                                        <tr style="border-bottom:1px solid #e9ecef;">
                                            <td style="padding:10px;font-weight:500;">${col.name}</td>
                                            <td style="padding:10px;color:#7f8c8d;">${col.dtype}</td>
                                            <td style="padding:10px;text-align:right;">
                                                <div style="background:#ecf0f1;border-radius:4px;height:20px;width:80px;display:inline-block;overflow:hidden;">
                                                    <div style="background:${col.fill_pct > 80 ? '#27ae60' : col.fill_pct > 50 ? '#f39c12' : '#e74c3c'};height:100%;width:${col.fill_pct}%;"></div>
                                                </div>
                                                <span style="margin-left:5px;">${col.fill_pct}%</span>
                                            </td>
                                            <td style="padding:10px;text-align:right;">${col.unique_count.toLocaleString()}</td>
                                            <td style="padding:10px;text-align:center;">
                                                <span style="padding:4px 10px;border-radius:4px;font-weight:500;background:${hasDuplicates ? '#fadbd8' : '#d5f5e3'};color:${hasDuplicates ? '#922b21' : '#1e8449'};">
                                                    ${hasDuplicates ? 'Yes' : 'No'}
                                                </span>
                                            </td>
                                            <td style="padding:10px;font-size:0.85em;color:#7f8c8d;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${col.sample_values}">${col.sample_values}</td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    document.getElementById('columnStatsCard').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading column stats:', error);
            }
        }

        async function downloadColumnStats() {
            try {
                const response = await fetch('/api/download-column-stats');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const disposition = response.headers.get('Content-Disposition');
                    a.download = disposition ? disposition.split('filename=')[1].replace(/"/g, '') : 'Column_Analysis.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Column analysis downloaded!', 'success');
                } else {
                    showMessage('Failed to download column analysis', 'danger');
                }
            } catch (error) {
                showMessage('Error downloading: ' + error.message, 'danger');
            }
        }

        // PDF Export
        function exportPDF() {
            showMessage('Generating PDF report...', 'success');

            // Create printable version
            const printWindow = window.open('', '_blank');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const totalRecords = document.getElementById('totalRecords').textContent;

            let chartsHTML = '';
            currentSettings.top_columns.forEach((col, index) => {
                const chartEl = document.getElementById(`chart_${index}`);
                if (chartEl) {
                    chartsHTML += `
                        <div style="margin-bottom:30px;page-break-inside:avoid;">
                            <h3 style="color:#2c3e50;margin-bottom:15px;">Top 10 ${col.display_name}</h3>
                            ${chartEl.innerHTML}
                        </div>
                    `;
                }
            });

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Dashboard Report - ${currentProject}</title>
                    <style>
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #2c3e50; }
                        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
                        h2 { color: #7f8c8d; margin-top: 30px; }
                        .summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
                        .summary-item { display: inline-block; margin-right: 40px; }
                        .summary-label { color: #7f8c8d; font-size: 0.9em; }
                        .summary-value { font-size: 1.5em; font-weight: 600; color: #2c3e50; }
                        .bar-chart-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
                        .bar-label { min-width: 150px; font-size: 0.85em; }
                        .bar-container { flex: 1; background: #ecf0f1; border-radius: 4px; height: 20px; }
                        .bar-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.75em; color: white; }
                        .bar-fill-1 { background: #e74c3c; }
                        .bar-fill-2 { background: #f39c12; }
                        .bar-fill-3 { background: #27ae60; }
                        .bar-fill-4 { background: #9b59b6; }
                        .bar-fill-5 { background: #3498db; }
                        .bar-fill-6 { background: #1abc9c; }
                        .bar-fill-7 { background: #e67e22; }
                        .bar-fill-8 { background: #2c3e50; }
                        .bar-fill-9 { background: #95a5a6; }
                        .bar-fill-10 { background: #34495e; }
                        .data-item { display: flex; justify-content: space-between; padding: 8px 12px; background: #f8f9fa; border-left: 3px solid #3498db; margin-bottom: 5px; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ecf0f1; color: #7f8c8d; font-size: 0.85em; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>Dashboard Report</h1>
                    <p style="color:#7f8c8d;">Project: <strong>${currentProject}</strong></p>

                    <div class="summary">
                        <div class="summary-item">
                            <div class="summary-label">Date Range</div>
                            <div class="summary-value">${formatDate(startDate)} to ${formatDate(endDate)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Records</div>
                            <div class="summary-value">${totalRecords}</div>
                        </div>
                    </div>

                    <h2>Data Analysis</h2>
                    ${chartsHTML}

                    <div class="footer">
                        <p>Generated on ${new Date().toLocaleString()} | Data Analytical and Compilation Tool</p>
                        <p>Prepared by Hamza Yahya - Internal Audit</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();

            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
    </script>

    <!-- Branding -->
    <div class="branding">
        Prepared by <strong>Hamza Yahya</strong> - Internal Audit
    </div>
</body>
</html>
